build:
  stage: build
  image: docker:latest
  services:
    - name: docker:dind
      alias: dind
  variables:
    DOCKER_DRIVER: overlay2
    IMAGE_NAME: rdrit/nginx-rproxy
  before_script:
    - apk add --no-cache docker-cli
    - docker info
    - echo "$CI_HUB_DOCKER_PASSWORD" | docker login -u "$CI_HUB_DOCKER_LOGIN" --password-stdin
  script:
    - |
      TAG_VERSION="$CI_COMMIT_TAG"

      echo "Tag Git dÃ©tectÃ© : ${TAG_VERSION}"

      if [[ "$TAG_VERSION" =~ ^beta- ]]; then
        echo "ðŸ‘‰ Build BETA (pas de latest)"
        docker build \
          -t ${IMAGE_NAME}:${TAG_VERSION} \
          -f Dockerfile .

        docker push ${IMAGE_NAME}:${TAG_VERSION}
      else
        echo "ðŸš€ Build RELEASE (latest mis Ã  jour)"
        docker build \
          -t ${IMAGE_NAME}:${TAG_VERSION} \
          -t ${IMAGE_NAME}:latest \
          -f Dockerfile .

        docker push ${IMAGE_NAME}:${TAG_VERSION}
        docker push ${IMAGE_NAME}:latest
      fi
  rules:
    - if: '$CI_COMMIT_TAG'
